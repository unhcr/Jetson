{"version":3,"sources":["../../../../lib/stream/xlsx/worksheet-reader.js"],"names":["events","require","Sax","_","utils","colCache","Dimensions","Row","Column","WorksheetReader","module","exports","workbook","id","name","_columns","_keys","_dimensions","inherits","EventEmitter","destroy","Error","dimensions","columns","getColumn","c","col","l2n","length","n","push","getColumnKey","key","setColumnKey","value","deleteColumnKey","eachColumnKey","f","each","_emitRow","row","emit","read","entry","options","emitSheet","emitHyperlinks","hyperlinks","worksheets","autodrain","sharedStrings","styles","properties","inCols","inRows","inHyperlinks","cols","current","parser","createStream","on","node","min","parseInt","attributes","max","width","parseFloat","styleId","style","r","ht","height","s","getStyleModel","ref","t","text","v","hyperlink","rId","fromModel","expandRow","address","decodeAddress","cell","getCell","formula","result","xmlDecode","index","sharedString","error","isDateFmt","numFmt","excelToDate","model","date1904","undefined","flowControl","createChild","pipe","sync"],"mappings":"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","file":"worksheet-reader.js","sourcesContent":["/**\r\n * Copyright (c) 2015-2017 Guyon Roche\r\n * LICENCE: MIT - please refer to LICENCE file included with this module\r\n * or https://github.com/guyonroche/exceljs/blob/master/LICENSE\r\n */\r\n\r\n'use strict';\r\n\r\nvar events = require('events');\r\nvar Sax = require('sax');\r\n\r\nvar _ = require('../../utils/under-dash');\r\nvar utils = require('../../utils/utils');\r\nvar colCache = require('../../utils/col-cache');\r\nvar Dimensions = require('../../doc/range');\r\n\r\nvar Row = require('../../doc/row');\r\nvar Column = require('../../doc/column');\r\n\r\nvar WorksheetReader = module.exports = function(workbook, id) {\r\n  this.workbook = workbook;\r\n  this.id = id;\r\n\r\n  // and a name\r\n  this.name = 'Sheet' + this.id;\r\n\r\n  // column definitions\r\n  this._columns = null;\r\n  this._keys = {};\r\n\r\n  // keep a record of dimensions\r\n  this._dimensions = new Dimensions();\r\n};\r\n\r\nutils.inherits(WorksheetReader, events.EventEmitter, {\r\n\r\n  // destroy - not a valid operation for a streaming writer\r\n  // even though some streamers might be able to, it's a bad idea.\r\n  destroy: function() {\r\n    throw new Error('Invalid Operation: destroy');\r\n  },\r\n\r\n  // return the current dimensions of the writer\r\n  get dimensions() {\r\n    return this._dimensions;\r\n  },\r\n\r\n  // =========================================================================\r\n  // Columns\r\n\r\n  // get the current columns array.\r\n  get columns() {\r\n    return this._columns;\r\n  },\r\n\r\n  // get a single column by col number. If it doesn't exist, it and any gaps before it\r\n  // are created.\r\n  getColumn: function(c) {\r\n    if (typeof c === 'string') {\r\n      // if it matches a key'd column, return that\r\n      var col = this._keys[c];\r\n      if (col) { return col; }\r\n\r\n      // otherise, assume letter\r\n      c = colCache.l2n(c);\r\n    }\r\n    if (!this._columns) { this._columns = []; }\r\n    if (c > this._columns.length) {\r\n      var n = this._columns.length + 1;\r\n      while (n <= c) {\r\n        this._columns.push(new Column(this, n++));\r\n      }\r\n    }\r\n    return this._columns[c - 1];\r\n  },\r\n\r\n  getColumnKey(key) {\r\n    return this._keys[key];\r\n  },\r\n  setColumnKey(key, value) {\r\n    this._keys[key] = value;\r\n  },\r\n  deleteColumnKey(key) {\r\n    delete this._keys[key];\r\n  },\r\n  eachColumnKey(f) {\r\n    _.each(this._keys, f);\r\n  },\r\n\r\n  // =========================================================================\r\n  // Read\r\n\r\n  _emitRow: function(row) {\r\n    this.emit('row', row);\r\n  },\r\n\r\n  read: function(entry, options) {\r\n    var emitSheet = false;\r\n    var emitHyperlinks = false;\r\n    var hyperlinks = null;\r\n    switch (options.worksheets) {\r\n      case 'emit':\r\n        emitSheet = true;\r\n        break;\r\n      case 'prep':\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n    switch (options.hyperlinks) {\r\n      case 'emit':\r\n        emitHyperlinks = true;\r\n        break;\r\n      case 'cache':\r\n        this.hyperlinks = hyperlinks = {};\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n    if (!emitSheet && !emitHyperlinks && !hyperlinks) {\r\n      entry.autodrain();\r\n      this.emit('finished');\r\n      return;\r\n    }\r\n\r\n    // references\r\n    var sharedStrings = this.workbook.sharedStrings;\r\n    var styles = this.workbook.styles;\r\n    var properties = this.workbook.properties;\r\n\r\n    // xml position\r\n    var inCols = false;\r\n    var inRows = false;\r\n    var inHyperlinks = false;\r\n\r\n    // parse state\r\n    var cols = null;\r\n    var row = null;\r\n    var c = null;\r\n    var current = null;\r\n\r\n    var parser = Sax.createStream(true, {});\r\n    parser.on('opentag', node => {\r\n      if (emitSheet) {\r\n        switch (node.name) {\r\n          case 'cols':\r\n            inCols = true;\r\n            cols = [];\r\n            break;\r\n          case 'sheetData':\r\n            inRows = true;\r\n            break;\r\n\r\n          case 'col':\r\n            if (inCols) {\r\n              cols.push({\r\n                min: parseInt(node.attributes.min, 10),\r\n                max: parseInt(node.attributes.max, 10),\r\n                width: parseFloat(node.attributes.width),\r\n                styleId: parseInt(node.attributes.style || '0', 10)\r\n              });\r\n            }\r\n            break;\r\n\r\n          case 'row':\r\n            if (inRows) {\r\n              var r = parseInt(node.attributes.r, 10);\r\n              row = new Row(this, r);\r\n              if (node.attributes.ht) {\r\n                row.height = parseFloat(node.attributes.ht);\r\n              }\r\n              if (node.attributes.s) {\r\n                var styleId = parseInt(node.attributes.s, 10);\r\n                var style = styles.getStyleModel(styleId);\r\n                if (style) {\r\n                  row.style = style;\r\n                }\r\n              }\r\n            }\r\n            break;\r\n          case 'c':\r\n            if (row) {\r\n              c = {\r\n                ref: node.attributes.r,\r\n                s: parseInt(node.attributes.s, 10),\r\n                t: node.attributes.t\r\n              };\r\n            }\r\n            break;\r\n          case 'f':\r\n            if (c) {\r\n              current = c.f = { text: '' };\r\n            }\r\n            break;\r\n          case 'v':\r\n            if (c) {\r\n              current = c.v = { text: '' };\r\n            }\r\n            break;\r\n          case 'mergeCell':\r\n            break;\r\n          default:\r\n            break;\r\n        }\r\n      }\r\n\r\n\r\n      // =================================================================\r\n      //\r\n      if (emitHyperlinks || hyperlinks) {\r\n        switch (node.name) {\r\n          case 'hyperlinks':\r\n            inHyperlinks = true;\r\n            break;\r\n          case 'hyperlink':\r\n            if (inHyperlinks) {\r\n              var hyperlink = {\r\n                ref: node.attributes.ref,\r\n                rId: node.attributes['r:id']\r\n              };\r\n              if (emitHyperlinks) {\r\n                this.emit('hyperlink', hyperlink);\r\n              } else {\r\n                hyperlinks[hyperlink.ref] = hyperlink;\r\n              }\r\n            }\r\n            break;\r\n          default:\r\n            break;\r\n        }\r\n      }\r\n    });\r\n\r\n    // only text data is for sheet values\r\n    parser.on('text', text => {\r\n      if (emitSheet) {\r\n        if (current) {\r\n          current.text += text;\r\n        }\r\n      }\r\n    });\r\n\r\n    parser.on('closetag', name => {\r\n      if (emitSheet) {\r\n        switch (name) {\r\n          case 'cols':\r\n            inCols = false;\r\n            this._columns = Column.fromModel(cols);\r\n            break;\r\n          case 'sheetData':\r\n            inRows = false;\r\n            break;\r\n\r\n          case 'row':\r\n            this._dimensions.expandRow(row);\r\n            this._emitRow(row);\r\n            row = null;\r\n            break;\r\n\r\n          case 'c':\r\n            if (row && c) {\r\n              var address = colCache.decodeAddress(c.ref);\r\n              var cell = row.getCell(address.col);\r\n              if (c.s) {\r\n                var style = styles.getStyleModel(c.s);\r\n                if (style) {\r\n                  cell.style = style;\r\n                }\r\n              }\r\n\r\n              if (c.f) {\r\n                var value = {\r\n                  formula: c.f.text\r\n                };\r\n                if (c.v) {\r\n                  if (c.t === 'str') {\r\n                    value.result = utils.xmlDecode(c.v.text);\r\n                  } else {\r\n                    value.result = parseFloat(c.v.text);\r\n                  }\r\n                }\r\n                cell.value = value;\r\n              } else if (c.v) {\r\n                switch (c.t) {\r\n                  case 's':\r\n                    var index = parseInt(c.v.text, 10);\r\n                    if (sharedStrings) {\r\n                      cell.value = sharedStrings[index];\r\n                    } else {\r\n                      cell.value = {\r\n                        sharedString: index\r\n                      };\r\n                    }\r\n                    break;\r\n                  case 'str':\r\n                    cell.value = utils.xmlDecode(c.v.text);\r\n                    break;\r\n                  case 'e':\r\n                    cell.value = { error: c.v.text };\r\n                    break;\r\n                  case 'b':\r\n                    cell.value = parseInt(c.v.text, 10) !== 0;\r\n                    break;\r\n                  default:\r\n                    if (utils.isDateFmt(cell.numFmt)) {\r\n                      cell.value = utils.excelToDate(parseFloat(c.v.text), properties.model.date1904);\r\n                    } else {\r\n                      cell.value = parseFloat(c.v.text);\r\n                    }\r\n                    break;\r\n                }\r\n              }\r\n              if (hyperlinks) {\r\n                var hyperlink = hyperlinks[c.ref];\r\n                if (hyperlink) {\r\n                  cell.text = cell.value;\r\n                  cell.value = undefined;\r\n                  cell.hyperlink = hyperlink;\r\n                }\r\n              }\r\n              c = null;\r\n            }\r\n            break;\r\n          default:\r\n            break;\r\n        }\r\n      }\r\n      if (emitHyperlinks || hyperlinks) {\r\n        switch (name) {\r\n          case 'hyperlinks':\r\n            inHyperlinks = false;\r\n            break;\r\n          default:\r\n            break;\r\n        }\r\n      }\r\n    });\r\n    parser.on('error', error => {\r\n      this.emit('error', error);\r\n    });\r\n    parser.on('end', () => {\r\n      this.emit('finished');\r\n    });\r\n\r\n    // create a down-stream flow-control to regulate the stream\r\n    var flowControl = this.workbook.flowControl.createChild();\r\n    flowControl.pipe(parser, {sync: true});\r\n    entry.pipe(flowControl);\r\n  }\r\n});\r\n"]}