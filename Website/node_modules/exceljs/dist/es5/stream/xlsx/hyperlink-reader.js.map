{"version":3,"sources":["../../../../lib/stream/xlsx/hyperlink-reader.js"],"names":["events","require","Sax","utils","Enums","RelType","HyperlinkReader","module","exports","workbook","id","_workbook","inherits","EventEmitter","count","hyperlinks","length","each","fn","forEach","read","entry","options","self","emitHyperlinks","autodrain","emit","parser","createStream","on","node","name","rId","attributes","Id","Type","Hyperlink","relationship","type","RelationshipType","Styles","target","Target","targetMode","TargetMode","flowControl","createChild","pipe","sync"],"mappings":"AAAA;;;;;;AAMA;;AAEA,IAAIA,SAASC,QAAQ,QAAR,CAAb;AACA,IAAIC,MAAMD,QAAQ,KAAR,CAAV;;AAEA,IAAIE,QAAQF,QAAQ,mBAAR,CAAZ;AACA,IAAIG,QAAQH,QAAQ,iBAAR,CAAZ;AACA,IAAII,UAAUJ,QAAQ,qBAAR,CAAd;;AAEA,IAAIK,kBAAkBC,OAAOC,OAAP,GAAiB,UAASC,QAAT,EAAmBC,EAAnB,EAAuB;AAC5D;AACA,OAAKA,EAAL,GAAUA,EAAV;;AAEA,OAAKC,SAAL,GAAiBF,QAAjB;AACD,CALD;;AAOAN,MAAMS,QAAN,CAAeN,eAAf,EAAgCN,OAAOa,YAAvC,EAAqD;;AAEnD,MAAIC,KAAJ,GAAY;AACV,WAAQ,KAAKC,UAAL,IAAmB,KAAKA,UAAL,CAAgBC,MAApC,IAA+C,CAAtD;AACD,GAJkD;;AAMnDC,QAAM,cAASC,EAAT,EAAa;AACjB,WAAO,KAAKH,UAAL,CAAgBI,OAAhB,CAAwBD,EAAxB,CAAP;AACD,GARkD;;AAUnDE,QAAM,cAASC,KAAT,EAAgBC,OAAhB,EAAyB;AAC7B,QAAIC,OAAO,IAAX;AACA,QAAIC,iBAAiB,KAArB;AACA,QAAIT,aAAa,IAAjB;AACA,YAAQO,QAAQP,UAAhB;AACE,WAAK,MAAL;AACES,yBAAiB,IAAjB;AACA;AACF,WAAK,OAAL;AACE,aAAKT,UAAL,GAAkBA,aAAa,EAA/B;AACA;AACF;AACE;AARJ;AAUA,QAAI,CAACS,cAAD,IAAmB,CAACT,UAAxB,EAAoC;AAClCM,YAAMI,SAAN;AACAF,WAAKG,IAAL,CAAU,UAAV;AACA;AACD;;AAED,QAAIC,SAASzB,IAAI0B,YAAJ,CAAiB,IAAjB,EAAuB,EAAvB,CAAb;AACAD,WAAOE,EAAP,CAAU,SAAV,EAAqB,UAASC,IAAT,EAAe;AAClC,UAAIA,KAAKC,IAAL,KAAc,cAAlB,EAAkC;AAChC,YAAIC,MAAMF,KAAKG,UAAL,CAAgBC,EAA1B;AACA,gBAAQJ,KAAKG,UAAL,CAAgBE,IAAxB;AACE,eAAK9B,QAAQ+B,SAAb;AACE,gBAAIC,eAAe;AACjBC,oBAAMlC,MAAMmC,gBAAN,CAAuBC,MADZ;AAEjBR,mBAAKA,GAFY;AAGjBS,sBAAQX,KAAKG,UAAL,CAAgBS,MAHP;AAIjBC,0BAAYb,KAAKG,UAAL,CAAgBW;AAJX,aAAnB;AAMA,gBAAIpB,cAAJ,EAAoB;AAClBD,mBAAKG,IAAL,CAAU,WAAV,EAAuBW,YAAvB;AACD,aAFD,MAEO;AACLtB,yBAAWsB,aAAaL,GAAxB,IAA+BK,YAA/B;AACD;AACD;AACF;AACE;AAfJ;AAiBD;AACF,KArBD;AAsBAV,WAAOE,EAAP,CAAU,KAAV,EAAiB,YAAW;AAC1BN,WAAKG,IAAL,CAAU,UAAV;AACD,KAFD;;AAIA;AACA,QAAImB,cAAc,KAAKlC,SAAL,CAAekC,WAAf,CAA2BC,WAA3B,EAAlB;AACAD,gBAAYE,IAAZ,CAAiBpB,MAAjB,EAAyB,EAACqB,MAAM,IAAP,EAAzB;AACA3B,UAAM0B,IAAN,CAAWF,WAAX;AACD;AA7DkD,CAArD","file":"hyperlink-reader.js","sourcesContent":["/**\r\n * Copyright (c) 2015-2017 Guyon Roche\r\n * LICENCE: MIT - please refer to LICENCE file included with this module\r\n * or https://github.com/guyonroche/exceljs/blob/master/LICENSE\r\n */\r\n\r\n'use strict';\r\n\r\nvar events = require('events');\r\nvar Sax = require('sax');\r\n\r\nvar utils = require('../../utils/utils');\r\nvar Enums = require('../../doc/enums');\r\nvar RelType = require('../../xlsx/rel-type');\r\n\r\nvar HyperlinkReader = module.exports = function(workbook, id) {\r\n  // in a workbook, each sheet will have a number\r\n  this.id = id;\r\n\r\n  this._workbook = workbook;\r\n};\r\n\r\nutils.inherits(HyperlinkReader, events.EventEmitter, {\r\n\r\n  get count() {\r\n    return (this.hyperlinks && this.hyperlinks.length) || 0;\r\n  },\r\n\r\n  each: function(fn) {\r\n    return this.hyperlinks.forEach(fn);\r\n  },\r\n\r\n  read: function(entry, options) {\r\n    var self = this;\r\n    var emitHyperlinks = false;\r\n    var hyperlinks = null;\r\n    switch (options.hyperlinks) {\r\n      case 'emit':\r\n        emitHyperlinks = true;\r\n        break;\r\n      case 'cache':\r\n        this.hyperlinks = hyperlinks = {};\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n    if (!emitHyperlinks && !hyperlinks) {\r\n      entry.autodrain();\r\n      self.emit('finished');\r\n      return;\r\n    }\r\n\r\n    var parser = Sax.createStream(true, {});\r\n    parser.on('opentag', function(node) {\r\n      if (node.name === 'Relationship') {\r\n        var rId = node.attributes.Id;\r\n        switch (node.attributes.Type) {\r\n          case RelType.Hyperlink:\r\n            var relationship = {\r\n              type: Enums.RelationshipType.Styles,\r\n              rId: rId,\r\n              target: node.attributes.Target,\r\n              targetMode: node.attributes.TargetMode\r\n            };\r\n            if (emitHyperlinks) {\r\n              self.emit('hyperlink', relationship);\r\n            } else {\r\n              hyperlinks[relationship.rId] = relationship;\r\n            }\r\n            break;\r\n          default:\r\n            break;\r\n        }\r\n      }\r\n    });\r\n    parser.on('end', function() {\r\n      self.emit('finished');\r\n    });\r\n\r\n    // create a down-stream flow-control to regulate the stream\r\n    var flowControl = this._workbook.flowControl.createChild();\r\n    flowControl.pipe(parser, {sync: true});\r\n    entry.pipe(flowControl);\r\n  }\r\n});\r\n"]}